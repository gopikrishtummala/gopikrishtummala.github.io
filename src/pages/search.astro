---
import "@pagefind/default-ui/css/ui.css";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE } from "@/config";

const backUrl = SITE.showBackButton ? `${Astro.url.pathname}` : "/";
---

<Layout title={`Search | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Search" pageDesc="Search any article ...">
    <div id="pagefind-search" transition:persist data-backurl={backUrl}>
      <!-- Placeholder search input for lazy loading -->
      <div class="search-placeholder">
        <input
          type="text"
          placeholder="Type to search..."
          class="w-full rounded-lg border border-white/40 bg-white/80 px-4 py-3 text-foreground shadow-sm backdrop-blur-sm transition focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20 dark:border-slate-700/40 dark:bg-slate-900/70"
          id="search-trigger"
        />
        <p class="mt-4 text-center text-sm text-secondary-foreground">
          Search will load when you start typing...
        </p>
      </div>
    </div>
  </Main>
  <Footer />
</Layout>

<script>
  let searchInitialized = false;
  let searchInstance: any = null;

  async function initSearch() {
    const pageFindSearch: HTMLElement | null =
      document.querySelector("#pagefind-search");

    if (!pageFindSearch || searchInitialized) return;

    // Show loading state
    pageFindSearch.innerHTML = `
      <div class="flex items-center justify-center py-8">
        <div class="text-center">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-accent border-r-transparent"></div>
          <p class="mt-4 text-sm text-secondary-foreground">Loading search index...</p>
        </div>
      </div>
    `;

    const params = new URLSearchParams(window.location.search);

    try {
      // @ts-expect-error â€” Missing types for @pagefind/default-ui package.
      const { PagefindUI } = await import("@pagefind/default-ui");

      // Display warning in dev mode
      if (import.meta.env.DEV) {
        pageFindSearch.innerHTML = `
            <div class="bg-muted/75 rounded p-4 space-y-4 mb-4">
              <p><strong>DEV mode Warning! </strong>You need to build the project at least once to see the search results during development.</p>
              <code class="block bg-black text-white px-2 py-1 rounded">pnpm run build</code>
            </div>
          `;
        return;
      }

      // Remove placeholder before initializing
      const placeholder = pageFindSearch.querySelector(".search-placeholder");
      if (placeholder) {
        placeholder.remove();
      }

      // Init pagefind ui
      searchInstance = new PagefindUI({
        element: "#pagefind-search",
        showSubResults: true,
        showImages: false,
        basePath: "/",
        processTerm: function (term: string) {
          params.set("q", term);
          history.replaceState(history.state, "", "?" + params.toString());

          const backUrl = pageFindSearch?.dataset?.backurl;
          sessionStorage.setItem("backUrl", backUrl + "?" + params.toString());

          return term;
        },
      });

      searchInitialized = true;

      // If search param exists (eg: search?q=astro), trigger search
      const query = params.get("q");
      if (query) {
        searchInstance.triggerSearch(query);
      }

      // Reset search param if search input is cleared
      const searchInput = document.querySelector(".pagefind-ui__search-input");
      const clearButton = document.querySelector(".pagefind-ui__search-clear");
      searchInput?.addEventListener("input", resetSearchParam);
      clearButton?.addEventListener("click", resetSearchParam);

      function resetSearchParam(e: Event) {
        if ((e.target as HTMLInputElement)?.value.trim() === "") {
          history.replaceState(history.state, "", window.location.pathname);
        }
      }
    } catch (error) {
      console.error("Failed to initialize search:", error);
      pageFindSearch.innerHTML = `
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded p-4">
          <p class="text-red-800 dark:text-red-200">Failed to load search. Please refresh the page.</p>
        </div>
      `;
    }
  }

  // Lazy load search only when needed
  function setupLazySearch() {
    const pageFindSearch = document.querySelector("#pagefind-search");
    if (!pageFindSearch) return;

    const params = new URLSearchParams(window.location.search);
    const hasQuery = params.get("q");
    const searchTrigger = document.querySelector("#search-trigger") as HTMLInputElement;

    // If there's a query param, load immediately (but with delay for better UX)
    if (hasQuery) {
      const onIdle = window.requestIdleCallback 
        ? (cb: () => void) => window.requestIdleCallback(cb, { timeout: 1000 })
        : (cb: () => void) => setTimeout(cb, 100);
      
      onIdle(initSearch);
      return;
    }

    // Otherwise, load on user interaction
    let loaded = false;
    const loadSearch = () => {
      if (loaded) return;
      loaded = true;
      initSearch();
    };

    // Load when user starts typing or focuses the input
    if (searchTrigger) {
      searchTrigger.addEventListener("focus", loadSearch, { once: true });
      searchTrigger.addEventListener("input", (e) => {
        loadSearch();
        // If search is initialized, trigger the actual search
        if (searchInstance && (e.target as HTMLInputElement).value) {
          setTimeout(() => {
            searchInstance.triggerSearch((e.target as HTMLInputElement).value);
          }, 100);
        }
      });
    }

    // Also load after a delay if user is still on page (low priority, background)
    const onIdle = window.requestIdleCallback 
      ? (cb: () => void) => window.requestIdleCallback(cb, { timeout: 5000 })
      : (cb: () => void) => setTimeout(cb, 3000);
    
    onIdle(loadSearch);
  }

  document.addEventListener("astro:after-swap", () => {
    searchInitialized = false;
    searchInstance = null;
    setupLazySearch();
  });
  
  // Initialize lazy search on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupLazySearch);
  } else {
    setupLazySearch();
  }
</script>

<style is:global>
  #pagefind-search {
    --pagefind-ui-font: var(--font-mono);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.375rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;

    form::before {
      background-color: var(--foreground);
    }

    input {
      font-weight: 400;
      border: 1px solid var(--border);
    }

    input:focus-visible {
      outline: 1px solid var(--accent);
    }

    .pagefind-ui__result-title a {
      color: var(--accent);
      outline-offset: 1px;
      outline-color: var(--accent);
    }

    .pagefind-ui__result-title a:focus-visible,
    .pagefind-ui__search-clear:focus-visible {
      text-decoration-line: none;
      outline-width: 2px;
      outline-style: dashed;
    }

    .pagefind-ui__result:last-of-type {
      border-bottom: 0;
    }

    .pagefind-ui__result-nested .pagefind-ui__result-link:before {
      font-family: system-ui;
    }
  }
</style>
