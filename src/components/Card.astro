---
import { slugifyStr } from "@/utils/slugify";
import type { CollectionEntry } from "astro:content";
import { getPostPath } from "@/utils/getPath";
import Datetime from "./Datetime.astro";

export interface Props extends CollectionEntry<"blog"> {
  variant?: "h2" | "h3";
}

const { variant = "h2", data, id, filePath } = Astro.props;
const post = Astro.props as CollectionEntry<"blog">;

// Ensure post.data exists (use destructured data if post.data is missing)
if (post && !post.data && data) {
  (post as any).data = data;
}

const { title, description, pubDatetime, modDatetime, timezone, difficulty, track, estimated_read_time, slug } = data;

/**
 * Extract part/module number and format title with unified numbering
 */
function formatTitleWithNumber(title: string, identifier: string): string {
  const partMatch = identifier.match(/-part-(\d+)$/);
  if (partMatch) {
    const partNum = parseInt(partMatch[1], 10);
    const paddedNum = partNum.toString().padStart(2, '0');
    if (title.match(/^Part \d+:/i)) {
      return title.replace(/^Part \d+:/i, `Part ${paddedNum}:`);
    }
    return `Part ${paddedNum}: ${title}`;
  }
  
  const moduleMatch = identifier.match(/-module-(\d+)$/);
  if (moduleMatch) {
    const moduleNum = parseInt(moduleMatch[1], 10);
    const paddedNum = moduleNum.toString().padStart(2, '0');
    if (title.match(/^Module \d+:/i)) {
      return title.replace(/^Module \d+:/i, `Module ${paddedNum}:`);
    }
    return `Module ${paddedNum}: ${title}`;
  }
  
  return title;
}

const identifier = slug || id.split('/').pop()?.replace(/\.(md|mdx)$/, '') || id;
const displayTitle = formatTitleWithNumber(title, identifier);

const difficultyColors = {
  Beginner: "bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border-emerald-500/20",
  Intermediate: "bg-amber-500/10 text-amber-600 dark:text-amber-400 border-amber-500/20",
  Advanced: "bg-rose-500/10 text-rose-600 dark:text-rose-400 border-rose-500/20",
};

const trackGradients = {
  Fundamentals: "from-blue-500 to-indigo-500",
  "GenAI Systems": "from-purple-500 to-fuchsia-500",
  "MLOps & Production": "from-cyan-500 to-blue-500",
  Robotics: "from-orange-500 to-red-500",
  "Agentic AI": "from-pink-500 to-rose-500",
};

const titleGradients = [
  "from-emerald-500 to-teal-500",
  "from-amber-500 to-orange-500",
  "from-violet-500 to-indigo-500",
  "from-blue-500 to-cyan-500",
  "from-sky-500 to-blue-500",
];

function getTitleGradient(slug: string): string {
  let hash = 0;
  for (let i = 0; i < slug.length; i++) {
    hash = ((hash << 5) - hash) + slug.charCodeAt(i);
    hash = hash & hash;
  }
  return titleGradients[Math.abs(hash) % titleGradients.length];
}

const titleGradient = getTitleGradient(id);
const headerClass = `bg-gradient-to-r ${titleGradient} bg-clip-text text-transparent transition-all duration-300 group-hover:brightness-110`;

const headerProps = {
  style: { viewTransitionName: slugifyStr(title) },
  class: headerClass,
};
---

<li class="group reveal">
  <article class="glass-card p-6 rounded-3xl h-full flex flex-col relative overflow-hidden group-hover:border-accent/30">
    <div class="flex items-center justify-between gap-4 mb-4">
      <div class="flex flex-wrap gap-2">
        {difficulty && difficulty in difficultyColors && (
          <span class={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border ${difficultyColors[difficulty as keyof typeof difficultyColors]}`}>
            {difficulty}
          </span>
        )}
        {track && (
          <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-accent/5 text-accent border border-accent/10">
            {track}
          </span>
        )}
      </div>
      {estimated_read_time && (
        <span class="text-[10px] font-bold text-secondary-foreground/40 uppercase tracking-tighter">
          {estimated_read_time} MIN READ
        </span>
      )}
    </div>

    <a href={getPostPath(post)} class="block mb-3 group/link">
      {variant === "h2" ? (
        <h2 {...headerProps} class={`${headerClass} text-2xl font-extrabold leading-tight`}>{displayTitle}</h2>
      ) : (
        <h3 {...headerProps} class={`${headerClass} text-xl font-bold leading-tight`}>{displayTitle}</h3>
      )}
    </a>

    <p class="text-sm text-secondary-foreground/80 leading-relaxed line-clamp-3 flex-1 mb-6">
      {description}
    </p>

    <div class="flex items-center justify-between mt-auto pt-4 border-t border-border/30">
      <time class="text-[10px] font-bold text-secondary-foreground/50 uppercase tracking-widest" datetime={new Date(pubDatetime).toISOString()}>
        {new Date(pubDatetime).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
      </time>
      <div class="size-8 rounded-full bg-accent/5 border border-accent/10 flex items-center justify-center text-accent group-hover:bg-accent group-hover:text-white transition-all duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>
      </div>
    </div>
  </article>
</li>
